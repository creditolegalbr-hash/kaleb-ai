<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Controle do WhatsApp - Kaleb AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .navbar { background-color: #075E54; }
        .qr-container {
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e9edef;
            border-radius: .5rem;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <i class="fas fa-arrow-left"></i>
            Voltar ao Dashboard
        </a>
    </div>
</nav>

<div class="container">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0"><i class="fab fa-whatsapp"></i> Conexão com WhatsApp</h5>
        </div>
        <div class="card-body text-center">
            <p>Use os botões abaixo para gerenciar o servidor de conexão com o WhatsApp.</p>
            
            <div class="mb-4">
                <h5>Passo 1: Iniciar o Servidor</h5>
                <p>Isso abrirá um novo terminal que vai gerar o QR Code. Pode levar até um minuto.</p>
                <a href="/start_wpp_server" class="btn btn-primary btn-lg">
                    <i class="fas fa-power-off"></i> Ligar Servidor WhatsApp
                </a>
            </div>

            <hr>

            <div class="mt-4">
                <h5>Passo 2: Escanear o QR Code</h5>
                <p>Assim que o servidor estiver pronto, o QR Code aparecerá abaixo. Escaneie com seu celular.</p>
                <div id="qr-wrapper" class="qr-container p-3">
                    <div id="qr-status">Aguardando o servidor gerar o QR Code...</div>
                </div>
                <button id="check-qr-btn" class="btn btn-secondary mt-3">Verificar QR Code Agora</button>
            </div>
        </div>
    </div>
</div>

<script>
    const qrStatus = document.getElementById('qr-status');
    const qrWrapper = document.getElementById('qr-wrapper');
    const checkQrBtn = document.getElementById('check-qr-btn');

    async function fetchQrCode() {
        try {
            const response = await fetch('/get_qr_code');
            if (response.ok) {
                const imageBlob = await response.blob();
                const imageUrl = URL.createObjectURL(imageBlob);
                qrWrapper.innerHTML = `<img src="${imageUrl}" alt="QR Code do WhatsApp" class="img-fluid">`;
                qrStatus.textContent = 'QR Code pronto! Escaneie com seu celular.';
            } else {
                qrStatus.textContent = 'Ainda não está pronto. Clique em "Verificar" novamente em alguns segundos.';
            }
        } catch (error) {
            console.error('Erro ao buscar QR code:', error);
            qrStatus.textContent = 'Erro ao conectar. Verifique se o servidor foi iniciado.';
        }
    }

    // Tenta buscar o QR code 5 segundos depois que a página carrega
    setTimeout(fetchQrCode, 5000);

    // Adiciona a funcionalidade ao botão
    checkQrBtn.addEventListener('click', fetchQrCode);
</script>

</body>
</html>